- name: Check if Node.js is installed
  shell: command -v node
  register: node_exists
  failed_when: false
  changed_when: false

- name: Check if npm is installed
  shell: command -v npm
  register: npm_exists
  failed_when: false
  changed_when: false

- name: Remove existing Node.js installation for force install
  apt:
    name: "{{ nodejs_packages }}"
    state: absent
  become: true
  when: force_install and (node_exists.rc == 0 or npm_exists.rc == 0)
  ignore_errors: true

- name: Install Node.js
  apt:
    name: "{{ nodejs_packages }}"
    state: "{{ package_state }}"
  become: true
  when: force_install or node_exists.rc != 0 or npm_exists.rc != 0

- name: Install npm global packages
  npm:
    name: "{{ item.name | default(item) }}"
    version: "{{ item.version | default(npm_package_version) }}"
    global: true
    state: latest
  become: true
  with_items: "{{ npm_global_packages }}"
  tags: [npm-global]

- name: Switch to latest Node.js LTS version
  command: "{{ node_lts_command }}"
  become: true
  tags: [switch-to-node-lts]

- name: Enable Corepack
  command: "{{ corepack_command }}"
  become: true

- name: Check Bun installed
  shell: command -v bun
  register: bun_exists
  ignore_errors: true
  tags: [bun]

- name: Remove existing Bun installation for force install
  file:
    path: "{{ ansible_env.HOME }}/.bun"
    state: absent
  when: force_install and bun_exists.rc == 0
  tags: [bun]

- name: Download Bun installer
  get_url:
    url: "{{ bun.install_url }}"
    dest: "{{ bun.install_script }}"
    mode: "{{ bun.script_mode }}"
    force: 'yes'
  when: force_install or bun_exists.rc != 0
  tags: [bun]

- name: Install Bun
  shell: "{{ bun.install_script }}"
  when: force_install or bun_exists.rc != 0
  tags: [bun]
